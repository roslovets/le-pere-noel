<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeu ‚Äî Assemble les phrases (Le P√®re No√´l)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Playfair+Display:wght@700&display=swap');
    :root {
      --r: 14px;
      --bg: #061216;
      --panel: rgba(12, 24, 31, 0.88);
      --panel-2: rgba(18, 32, 41, 0.82);
      --border: rgba(255, 255, 255, 0.14);
      --text: #f6fbff;
      --muted: #cfdceb;
      --accent: #e7445b;
      --accent-2: #1ea06d;
      --gold: #f4c36a;
    }

    * { box-sizing: border-box; }
    body {
      font-family: 'Manrope', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      background:
        radial-gradient(circle at 20% 20%, rgba(244, 195, 106, 0.18), transparent 28%),
        radial-gradient(circle at 82% 8%, rgba(231, 68, 91, 0.16), transparent 30%),
        linear-gradient(135deg, #07131a, #0b1c22 45%, #0f152c);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 20px 18px 36px; }
    .top {
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding: 14px 16px;
      background: linear-gradient(115deg, rgba(28, 129, 88, 0.95), rgba(216, 72, 93, 0.95));
      border:1px solid rgba(255, 255, 255, 0.22);
      border-radius: var(--r);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.32), 0 10px 34px rgba(231, 68, 91, 0.25);
    }
    .title { font-weight:700; letter-spacing:.3px; font-size:20px; font-family:'Playfair Display','Manrope',serif; color:#fff; }
    .meta { display:flex; gap:10px; flex-wrap:wrap; opacity:.95; font-size:14px; color:#fff; }
    .pill { padding:6px 10px; border:1px solid rgba(255,255,255,0.3); border-radius:999px; background: rgba(255,255,255,0.12); backdrop-filter: blur(6px); }
    .grid { display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; margin-top:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .card { background: var(--panel); border:1px solid var(--border); border-radius: var(--r); padding: 16px; box-shadow: 0 12px 28px rgba(0,0,0,0.28); }
    .card h3 { margin:0 0 10px; font-size: 17px; letter-spacing:.2px; color: #fdf3e6; }
    .small { font-size: 13px; opacity:.9; line-height:1.45; color: var(--muted); }

    .translation {
      margin: 10px 0 12px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(244, 195, 106, 0.4);
      background: linear-gradient(135deg, rgba(20, 80, 58, 0.9), rgba(22, 110, 72, 0.85));
      color: #f5fff6;
      box-shadow: 0 14px 30px rgba(6, 35, 23, 0.4);
    }
    .translation .label { text-transform: uppercase; letter-spacing: .35px; font-size: 11px; color: #c7ffd6; opacity:.95; }
    .translation .ru { margin-top: 6px; font-size: 15px; font-weight: 700; }

    .zone {
      min-height: 64px; padding: 10px; border-radius: 12px;
      border:1px dashed rgba(244, 195, 106, 0.4); background: var(--panel-2);
      display:flex; flex-wrap:wrap; gap:8px; align-items:flex-start;
    }

    .tokens { display:flex; flex-wrap:wrap; gap:8px; }
    .token {
      user-select:none; cursor:pointer;
      padding: 9px 11px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(135deg, rgba(35, 119, 84, 0.95), rgba(30, 156, 100, 0.95));
      color:#f6fff4;
      font-size: 14px; line-height:1;
      box-shadow: 0 10px 22px rgba(18, 98, 68, 0.35);
      transition: transform .06s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .token:hover { transform: translateY(-2px); border-color: rgba(244, 195, 106, 0.9); box-shadow: 0 12px 26px rgba(231, 68, 91, 0.25); }
    .token:active { transform: translateY(0px) scale(0.99); }
    .token.bad { border-color:#ff8d8d; background: linear-gradient(135deg, #5f1c1c, #8c2d2d); }
    .token.good { border-color:#a4ffc4; background: linear-gradient(135deg, #1c5f3a, #278b56); }
    .token.dragover { outline: 2px dashed var(--gold); outline-offset: 2px; }

    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    button {
      cursor:pointer; border:none; border-radius: 12px;
      padding: 11px 13px; background: linear-gradient(135deg, #e7445b, #f67767); color:#fff; font-weight:700;
      box-shadow: 0 12px 26px rgba(231, 68, 91, 0.32);
      transition: transform .07s ease, box-shadow .15s ease, filter .15s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 14px 28px rgba(244, 195, 106, 0.25); filter: brightness(1.02); }
    button.secondary { background: linear-gradient(135deg, #176846, #1e8a5b); border:1px solid rgba(160, 255, 198, 0.4); box-shadow: 0 12px 24px rgba(18, 98, 68, 0.3); }
    button.danger { background: linear-gradient(135deg, #8d1f1f, #b73232); }
    button:disabled { opacity:.45; cursor:not-allowed; box-shadow: none; transform:none; }

    .status { margin-top: 10px; font-size: 14px; }
    .ok { color:#afffba; }
    .no { color:#ffc5c5; }
    .hint { margin-top: 8px; font-size: 13px; opacity:.9; color: var(--muted); }

    .answerBox {
      margin-top: 10px; padding: 12px; border-radius: 12px;
      border:1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.04);
      display:none;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .progressSegments { display:flex; gap:6px; align-items:center; margin-top: 12px; }
    .seg {
      flex:1; min-width:14px; height: 10px;
      border-radius: 999px; background: rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2);
      transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .seg.current { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(244, 195, 106, 0.35); border-color: rgba(244,195,106,0.9); }
    .seg.ok { background: linear-gradient(135deg, #1e8a5b, #2fb879); border-color: rgba(160,255,198,0.7); }
    .seg.fail { background: linear-gradient(135deg, #8d1f1f, #b73232); border-color: rgba(255,141,141,0.8); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:2px 6px; border:1px solid rgba(255,255,255,0.2); border-radius:8px; background: rgba(255,255,255,0.08); color:#f6fbff; }

    @media (max-width: 640px) {
      .progressSegments { flex-wrap: wrap; gap:4px; }
      .seg { flex: 1 0 calc(16% - 4px); min-width: 22px; height: 8px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Jeu: assemble les phrases ‚Äî <span style="opacity:.85">Le P√®re No√´l üéÖ</span></div>
      <div class="meta">
        <div class="pill">Phrase: <span id="idx">1</span>/<span id="total">0</span></div>
        <div class="pill">Score: <span id="score">0</span></div>
      </div>
    </div>

    <div class="progressSegments" id="progressSegments"></div>

    <div class="grid">
      <div class="card">
        <h3>–°–æ–±–µ—Ä–∏ —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –∫—É—Å–æ—á–∫–æ–≤</h3>

        <div class="translation">
          <div class="label">–ü–µ—Ä–µ–≤–æ–¥</div>
          <div id="instantRU" class="ru"></div>
        </div>

        <div class="small" style="margin:10px 0 6px;">–¢–µ–∫—É—â–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (—Ç–≤–æ—è —Å–±–æ—Ä–∫–∞):</div>
        <div class="zone" id="built"></div>

        <div class="actions">
          <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="showBtn" class="secondary">–°–¥–∞—Ç—å—Å—è</button>
          <button id="resetBtn" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <button id="prevBtn" class="secondary">‚Üê –ü—Ä–µ–¥.</button>
          <button id="nextBtn" class="secondary">–°–ª–µ–¥. ‚Üí</button>
        </div>

        <div class="status" id="status"></div>

        <div class="answerBox" id="answerBox">
          <div class="small" style="opacity:.95; margin-bottom:6px;">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</div>
          <div id="answerFR" style="font-weight:700; margin-bottom:8px;"></div>
          <div class="small" style="opacity:.9;">–ü–µ—Ä–µ–≤–æ–¥ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä):</div>
          <div id="answerRU" style="margin-top:4px;"></div>
        </div>
      </div>

      <div class="card">
        <h3>–ö—É—Å–æ—á–∫–∏ (–µ—Å—Ç—å –ª–∏—à–Ω–∏–µ!)</h3>

        <div class="tokens" id="pool"></div>
      </div>
    </div>
  </div>

  <div style="text-align:center; margin: 5px auto 35px; opacity:.8; font-size:13px;">
    <a href="sentences.html" style="color:#a4ffc4; font-weight:700; text-decoration:none;">–í—Å–µ —Ñ—Ä–∞–∑—ã</a>
  </div>

<script>
/**
 * –î–∞–Ω–Ω—ã–µ: –±–µ—Ä—ë–º —Ç–≤–æ–π —Ç–µ–∫—Å—Ç (—Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∞—è —Ñ—Ä–∞–∑–∞ + —Ä—É—Å—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥),
 * –∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º:
 * - tokens: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫—É—Å–æ—á–∫–∏
 * - distractors: –ª–∏—à–Ω–∏–µ –∫—É—Å–æ—á–∫–∏ —Å –ø–æ–¥–≤–æ—Ö–æ–º
 *
 * –¢–æ–∫–µ–Ω—ã –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å —Å–ª–æ–∂–Ω–µ–µ/–ª–µ–≥—á–µ.
 */
const SENTENCES = [
  { fr: "Quel est le symbole principal de No√´l, apr√®s le sapin et Coca-Cola ?", ru: "–ö–∞–∫–æ–π –≥–ª–∞–≤–Ω—ã–π —Å–∏–º–≤–æ–ª –†–æ–∂–¥–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ —ë–ª–∫–∏ –∏ Coca-Cola?" },
  { fr: "Qui vient la nuit chez nos enfants et leur apporte des cadeaux pour le Nouvel An ?", ru: "–ö—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ –Ω–∞—à–∏–º –¥–µ—Ç—è–º –ø–æ –Ω–æ—á–∞–º –∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç –∏–º –ø–æ–¥–∞—Ä–∫–∏ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥?" },
  { fr: "C‚Äôest le P√®re No√´l ou bien saint Nicolas.", ru: "–≠—Ç–æ –î–µ–¥ –ú–æ—Ä–æ–∑, –∏–ª–∏ —Å–≤—è—Ç–æ–π –ù–∏–∫–æ–ª–∞–π." },
  { fr: "Mais pourquoi sommes-nous si attach√©s √† ce personnage ?", ru: "–ù–æ –ø–æ—á–µ–º—É –º—ã —Ç–∞–∫ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂—É?" },
  { fr: "Pourquoi notre culture le fait revenir chaque ann√©e ?", ru: "–ü–æ—á–µ–º—É –Ω–∞—à–∞ –∫—É–ª—å—Ç—É—Ä–∞ ¬´–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç¬ª –µ–≥–æ –∫–∞–∂–¥—ã–π –≥–æ–¥?" },
  { fr: "En ce moment, j‚Äôexplique √† mon petit gar√ßon qu‚Äôil a un papy Dima, un papy Vova et un troisi√®me papy : Ded Moroz. Ce n‚Äôest pas cringe, √ßa ?", ru: "–°–µ–π—á–∞—Å —è –æ–±—ä—è—Å–Ω—è—é —Å–≤–æ–µ–º—É –º–∞–ª–µ–Ω—å–∫–æ–º—É —Å—ã–Ω—É, —á—Ç–æ —É –Ω–µ–≥–æ –µ—Å—Ç—å –¥–µ–¥ –î–∏–º–∞, –¥–µ–¥ –í–æ–≤–∞ –∏ –µ—â—ë –∫–∞–∫–æ–π-—Ç–æ —Ç—Ä–µ—Ç–∏–π –¥–µ–¥: –î–µ–¥ –ú–æ—Ä–æ–∑. –≠—Ç–æ –Ω–µ –∫—Ä–∏–Ω–∂, –∞?" },
  { fr: "Claude L√©vi-Strauss, un anthropologue fran√ßais, parle de cette question dans son essai Le P√®re No√´l supplici√©.", ru: "–ö–ª–æ–¥ –õ–µ–≤–∏-–°—Ç—Ä–æ—Å—Å, —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –∞–Ω—Ç—Ä–æ–ø–æ–ª–æ–≥, –≥–æ–≤–æ—Ä–∏—Ç –æ–± —ç—Ç–æ–º –≤ —Å–≤–æ—ë–º —ç—Å—Å–µ Le P√®re No√´l supplici√©." },
  { fr: "Dans cet essai, il d√©crit une sc√®ne tr√®s choquante.", ru: "–í —ç—Ç–æ–º —ç—Å—Å–µ –æ–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—á–µ–Ω—å —à–æ–∫–∏—Ä—É—é—â—É—é —Å—Ü–µ–Ω—É." },
  { fr: "Elle a eu lieu √† Dijon, le 23 d√©cembre 1951.", ru: "–û–Ω–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤ –î–∏–∂–æ–Ω–µ 23 –¥–µ–∫–∞–±—Ä—è 1951 –≥–æ–¥–∞." },
  { fr: "Des adultes, de bons chr√©tiens, ont install√© une grande statue de saint Nicolas devant la cath√©drale.", ru: "–í–∑—Ä–æ—Å–ª—ã–µ, –¥–æ–±—Ä–æ–ø–æ—Ä—è–¥–æ—á–Ω—ã–µ —Ö—Ä–∏—Å—Ç–∏–∞–Ω–µ, –ø–æ—Å—Ç–∞–≤–∏–ª–∏ —É —Å–æ–±–æ—Ä–∞ –±–æ–ª—å—à—É—é —Å—Ç–∞—Ç—É—é —Å–≤—è—Ç–æ–≥–æ –ù–∏–∫–æ–ª–∞—è." },
  { fr: "Ils ont amen√© leurs enfants.", ru: "–û–Ω–∏ –ø—Ä–∏–≤–µ–ª–∏ —Å–≤–æ–∏—Ö –¥–µ—Ç–µ–π." },
  { fr: "Mais ce n‚Äô√©tait pas une f√™te joyeuse‚Ä¶ C‚Äô√©tait un supplice tr√®s cruel.", ru: "–ù–æ —ç—Ç–æ –±—ã–ª–æ –Ω–µ —Ä–∞–¥–æ—Å—Ç–Ω–æ–µ —Ç–æ—Ä–∂–µ—Å—Ç–≤–æ‚Ä¶ –≠—Ç–æ –±—ã–ª–æ –æ—á–µ–Ω—å –∂–µ—Å—Ç–æ–∫–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ." },
  { fr: "Devant les enfants, ils ont mis de l‚Äôessence sur le P√®re No√´l. Puis ils ont mis le feu.", ru: "–ü—Ä—è–º–æ –ø—Ä–∏ –¥–µ—Ç—è—Ö –æ–Ω–∏ –Ω–∞–ª–∏–ª–∏ –±–µ–Ω–∑–∏–Ω –Ω–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞. –ü–æ—Ç–æ–º –ø–æ–¥–æ–∂–≥–ª–∏." },
  { fr: "Les pauvres enfants regardaient, avec peur, leur h√©ros pr√©f√©r√© qui br√ªlait.", ru: "–ë–µ–¥–Ω—ã–µ –¥–µ—Ç–∏ –≤ —Å—Ç—Ä–∞—Ö–µ —Å–º–æ—Ç—Ä–µ–ª–∏, –∫–∞–∫ –≥–æ—Ä–∏—Ç –∏—Ö –ª—é–±–∏–º—ã–π –≥–µ—Ä–æ–π." },
  { fr: "Pourquoi les adultes ont fait √ßa ?", ru: "–ü–æ—á–µ–º—É –≤–∑—Ä–æ—Å–ª—ã–µ —ç—Ç–æ —Å–¥–µ–ª–∞–ª–∏?" },
  { fr: "Parce que ces chr√©tiens voulaient dire non √† un No√´l trop commercial.", ru: "–ü–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–∏ —Ö—Ä–∏—Å—Ç–∏–∞–Ω–µ —Ö–æ—Ç–µ–ª–∏ –≤—ã—Å—Ç—É–ø–∏—Ç—å –ø—Ä–æ—Ç–∏–≤ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –†–æ–∂–¥–µ—Å—Ç–≤–∞ –≤ —Å–ª–∏—à–∫–æ–º –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫." },
  { fr: "Pour eux, le P√®re No√´l faisait concurrence √† J√©sus.", ru: "–î–ª—è –Ω–∏—Ö –ü—ç—Ä –ù–æ—ç–ª—å –∫–æ–Ω–∫—É—Ä–∏—Ä–æ–≤–∞–ª —Å –ò–∏—Å—É—Å–æ–º." },
  { fr: "Et cette comparaison me pla√Æt.", ru: "–ò –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —ç—Ç–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ." },
  { fr: "Nous savons que ce vieux monsieur n‚Äôexiste pas, mais nous avons besoin du mythe du P√®re No√´l.", ru: "–ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ —ç—Ç–æ–≥–æ —Å—Ç–∞—Ä–∏–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–∞–º –Ω—É–∂–µ–Ω –º–∏—Ñ –æ –î–µ–¥–µ –ú–æ—Ä–æ–∑–µ." },
  { fr: "La diff√©rence, c‚Äôest que Dieu est un mythe pour les adultes, et le P√®re No√´l est un mythe que nous cr√©ons pour les enfants.", ru: "–†–∞–∑–Ω–∏—Ü–∞ –≤ —Ç–æ–º, —á—Ç–æ –ë–æ–≥ ‚Äî –º–∏—Ñ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö, –∞ –î–µ–¥ –ú–æ—Ä–æ–∑ ‚Äî –º–∏—Ñ, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–æ–∑–¥–∞–µ–º –¥–ª—è –¥–µ—Ç–µ–π." },
  { fr: "L√©vi-Strauss donne plusieurs r√©ponses possibles √† la question de savoir pourquoi on fait √ßa.", ru: "–õ–µ–≤–∏-–°—Ç—Ä–æ—Å—Å –¥–∞—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å, –ø–æ—á–µ–º—É –º—ã —ç—Ç–æ –¥–µ–ª–∞–µ–º." },
  { fr: "Mais moi, je pense que la raison est simple.", ru: "–ù–æ —è –¥—É–º–∞—é, —á—Ç–æ –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ—Å—Ç–∞—è." },
  { fr: "Nous voulons offrir √† nos enfants un peu d‚Äôimagination et de joie.", ru: "–ú—ã —Ö–æ—Ç–∏–º –ø–æ–¥–∞—Ä–∏—Ç—å –Ω–∞—à–∏–º –¥–µ—Ç—è–º –Ω–µ–º–Ω–æ–≥–æ —Ñ–∞–Ω—Ç–∞–∑–∏–∏ –∏ —Ä–∞–¥–æ—Å—Ç–∏." },
  { fr: "M√™me si c‚Äôest un papy bizarre en costume rouge, qui boit du Coca.", ru: "–î–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–∞–Ω–Ω—ã–π –¥–µ–¥ –≤ –∫—Ä–∞—Å–Ω–æ–º –∫–æ—Å—Ç—é–º–µ, –∫–æ—Ç–æ—Ä—ã–π –ø—å—ë—Ç –∫–æ–ª—É." },
  { fr: "Au fait, demain, nous allons √† la maison du P√®re No√´l pr√®s du Capitole.", ru: "–ö—Å—Ç–∞—Ç–∏, –∑–∞–≤—Ç—Ä–∞ –º—ã –∏–¥—ë–º –≤ –¥–æ–º–∏–∫ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ —É –ö–∞–ø–∏—Ç–æ–ª–∏—è." },
  { fr: "Venez vous aussi !", ru: "–ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∏ –≤—ã!" },
];

// –ü—Ä–æ—Å—Ç–∞—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è: —Å–ª–æ–≤–∞ + –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
function tokenizeFR(fr) {
  const spaced = fr.replace(/\s+/g, " ").trim();
  return spaced.split(" ");
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–æ–≤—É—à–µ–∫: "–ø–æ—á—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ" —ç–ª–µ–º–µ–Ω—Ç—ã
function makeDistractors(tokens, fr) {
  const d = new Set();

  // –û–±—â–∏–µ –ª–æ–≤—É—à–∫–∏
  ["de", "du", "des", "le", "la", "les", "un", "une", "√†", "au", "aux", "en", "dans", "sur", "chez",
   "ne", "pas", "plus", "tr√®s", "trop", "bien", "aussi", "ce", "cette", "cet", "ces",
   "pour", "par", "avec", "sans", "que", "qui", "quoi", "o√π", "quand", "comment"
  ].forEach(x => { if (!tokens.includes(x)) d.add(x); });

  // –õ–æ–≤—É—à–∫–∏ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –∫—É—Å–∫–∞–º–∏
  if (tokens.includes("on")) d.add("nous");
  if (tokens.includes("nous")) d.add("on");

  if (fr.includes("Coca-Cola")) d.add("Coca"); // –æ–±—Ä–µ–∂–µ–º –±—Ä–µ–Ω–¥
  if (fr.includes("Nouvel")) { d.add("Nouvelle"); d.add("No√´l"); }
  if (fr.includes("P√®re")) { d.add("Pere"); d.add("le P√®re"); d.add("P√®re"); } // –≤–∞—Ä–∏–∞–Ω—Ç—ã
  if (fr.includes("saint")) { d.add("Sainte"); d.add("Saint"); }

  // –í—Ä–µ–º–µ–Ω–∞/—Ñ–æ—Ä–º–∞ –≥–ª–∞–≥–æ–ª–∞
  if (tokens.includes("voulait")) d.add("veut");
  if (tokens.includes("ont")) d.add("a");
  if (tokens.includes("est")) d.add("√©tais");
  if (tokens.includes("sommes-nous")) d.add("sommes");
  if (tokens.includes("allons")) d.add("va");

  // –û–≥—Ä–∞–Ω–∏—á–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
  return Array.from(d).filter(x => x && !tokens.includes(x));
}

function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function joinTokens(tokens) {
  return tokens.join(" ").replace(/\s+/g," ").trim();
}

let state = {
  i: 0,
  built: [],
  pool: [],
  score: 0,
  solved: new Set(), // –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ—à—ë–Ω–Ω—ã—Ö
  results: Array(SENTENCES.length).fill("pending"), // per-phrase: "pending" | "ok" | "fail"
};

const elIdx = document.getElementById("idx");
const elTotal = document.getElementById("total");
const elScore = document.getElementById("score");
const elPool = document.getElementById("pool");
const elBuilt = document.getElementById("built");
const elStatus = document.getElementById("status");
const elAnswerBox = document.getElementById("answerBox");
const elAnswerFR = document.getElementById("answerFR");
const elAnswerRU = document.getElementById("answerRU");
const elInstantRU = document.getElementById("instantRU");
const elSegments = document.getElementById("progressSegments");
const STORAGE_KEY = "pere-noel-progress";
let currentTokens = [];
let currentDistractors = [];

document.getElementById("checkBtn").addEventListener("click", check);
document.getElementById("showBtn").addEventListener("click", showAnswer);
document.getElementById("resetBtn").addEventListener("click", resetBuilt);
document.getElementById("prevBtn").addEventListener("click", () => go(-1));
document.getElementById("nextBtn").addEventListener("click", () => go(+1));

function render() {
  elTotal.textContent = SENTENCES.length;
  elIdx.textContent = (state.i + 1);
  elScore.textContent = String(state.score);

  elStatus.textContent = "";
  elStatus.className = "status";
  elAnswerBox.style.display = "none";
  elInstantRU.textContent = SENTENCES[state.i].ru;
  updateSegments();

  // –†–µ–Ω–¥–µ—Ä —Å–æ–±—Ä–∞–Ω–Ω–æ–π –∑–æ–Ω—ã
  elBuilt.innerHTML = "";
  state.built.forEach((tok, idx) => {
    const b = document.createElement("span");
    b.className = "token";
    b.textContent = tok;
    b.title = "–ö–ª–∏–∫ ‚Äî —É–±—Ä–∞—Ç—å –≤–Ω–∏–∑";
    b.draggable = true;
    b.addEventListener("click", () => {
      // —É–±—Ä–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –≤–Ω–∏–∑
      state.built.splice(idx, 1);
      state.pool.push(tok);
      state.pool = shuffle(state.pool);
      render();
    });
    b.addEventListener("dragstart", (e) => {
      e.dataTransfer?.setData("text/plain", String(idx));
      e.dataTransfer?.setDragImage(b, 10, 10);
    });
    b.addEventListener("dragover", (e) => {
      e.preventDefault();
      b.classList.add("dragover");
    });
    b.addEventListener("dragleave", () => b.classList.remove("dragover"));
    b.addEventListener("drop", (e) => {
      e.preventDefault();
      b.classList.remove("dragover");
      const from = Number(e.dataTransfer?.getData("text/plain"));
      const to = idx;
      if (Number.isInteger(from)) {
        const [item] = state.built.splice(from, 1);
        state.built.splice(to, 0, item);
        render();
      }
    });
    b.addEventListener("dragend", () => b.classList.remove("dragover"));
    elBuilt.appendChild(b);
  });

  // –†–µ–Ω–¥–µ—Ä –ø—É–ª–∞ —Ç–æ–∫–µ–Ω–æ–≤
  elPool.innerHTML = "";
  state.pool.forEach((tok, idx) => {
    const t = document.createElement("span");
    t.className = "token";
    t.textContent = tok;
    t.title = "–ö–ª–∏–∫ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–≤–µ—Ä—Ö";
    t.addEventListener("click", () => {
      state.pool.splice(idx, 1);
      state.built.push(tok);
      render();
    });
    elPool.appendChild(t);
  });

  // –ö–Ω–æ–ø–∫–∏ prev/next
  document.getElementById("prevBtn").disabled = state.i === 0;
  document.getElementById("nextBtn").disabled = state.i === SENTENCES.length - 1;
}

function updateSegments() {
  if (!elSegments) return;
  elSegments.innerHTML = "";
  const res = state.results.length === SENTENCES.length ? state.results : Array(SENTENCES.length).fill("pending");
  res.forEach((status, idx) => {
    const seg = document.createElement("div");
    seg.className = "seg";
    if (status === "ok") seg.classList.add("ok");
    if (status === "fail") seg.classList.add("fail");
    if (idx === state.i) seg.classList.add("current");
    seg.title = `–§—Ä–∞–∑–∞ ${idx + 1} / ${SENTENCES.length}`;
    elSegments.appendChild(seg);
  });
}

// –ü–æ–∑–≤–æ–ª—è–µ–º –±—Ä–æ—Å–∞—Ç—å –Ω–∞ –ø—É—Å—Ç—É—é –∑–æ–Ω—É, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–æ–Ω–µ—Ü
elBuilt.addEventListener("dragover", (e) => e.preventDefault());
elBuilt.addEventListener("drop", (e) => {
  e.preventDefault();
  const from = Number(e.dataTransfer?.getData("text/plain"));
  if (!Number.isInteger(from)) return;
  const [item] = state.built.splice(from, 1);
  state.built.push(item);
  render();
});

function saveProgress() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      i: state.i,
      results: state.results,
      score: state.score,
      solved: Array.from(state.solved),
    }));
  } catch (_) {}
}

function restoreProgress() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (parsed && Array.isArray(parsed.results) && parsed.results.length === SENTENCES.length) {
      state.results = parsed.results;
      state.i = Math.min(Math.max(Number(parsed.i) || 0, 0), SENTENCES.length - 1);
      state.score = Number.isInteger(parsed.score) ? parsed.score : 0;
      const solvedArr = Array.isArray(parsed.solved) ? parsed.solved : [];
      state.solved = new Set(solvedArr.filter((x) => Number.isInteger(x)));
      // –¥–æ–±–∞–≤–∏–º —Ä–µ—à—ë–Ω–Ω—ã–µ –ø–æ results, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤ solved
      state.results.forEach((v, idx) => { if (v === "ok") state.solved.add(idx); });
      state.score = state.solved.size;
    }
  } catch (_) {}
}

function loadSentence(i) {
  state.i = i;
  const s = SENTENCES[state.i];
  const tokens = tokenizeFR(s.fr);
  currentTokens = tokens;

  // –¥–µ–ª–∞–µ–º –ª–æ–≤—É—à–∫–∏ (—á–∞—Å—Ç—å –≤–æ–∑—å–º—ë–º —Å–ª—É—á–∞–π–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å)
  const distractors = shuffle(makeDistractors(tokens, s.fr)).slice(0, Math.min(8, Math.max(4, Math.floor(tokens.length/3))));
  currentDistractors = distractors;

  // –µ—Å–ª–∏ —É–∂–µ —Ä–µ—à–µ–Ω–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–º
  if (state.results[state.i] === "ok") {
    // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ solved –∏ score —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã
    state.solved.add(state.i);
    state.score = state.solved.size;
    state.built = [...tokens];
    state.pool = [...distractors];
  } else {
    state.built = [];
    state.pool = shuffle([...tokens, ...distractors]);
  }
  render();
  saveProgress();
}

function resetBuilt(){
  // –≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë –≤–Ω–∏–∑
  const tokens = tokenizeFR(SENTENCES[state.i].fr);
  const distractors = shuffle(makeDistractors(tokens, SENTENCES[state.i].fr)).slice(0, Math.min(8, Math.max(4, Math.floor(tokens.length/3))));

  if (state.results[state.i] === "ok") {
    state.results[state.i] = "pending";
    state.solved.delete(state.i);
    state.score = state.solved.size;
  } else if (state.results[state.i] === "fail") {
    state.results[state.i] = "pending";
  }

  state.pool = shuffle([...tokens, ...distractors]);
  state.built = [];
  elStatus.textContent = "";
  elStatus.className = "status";
  elAnswerBox.style.display = "none";
  render();
  saveProgress();
}

function check() {
  const target = SENTENCES[state.i].fr;
  const attempt = joinTokens(state.built);

  if (attempt === target) {
    elStatus.textContent = "‚úÖ –í–µ—Ä–Ω–æ! –û—Ç–ª–∏—á–Ω–æ.";
    elStatus.className = "status ok";
    state.results[state.i] = "ok";
    if (!state.solved.has(state.i)) {
      state.solved.add(state.i);
      state.score += 1;
      elScore.textContent = String(state.score);
    }
    // –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –≤–µ—Ä–Ω—ã–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω—ã –±—ã–ª–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–Ω–∞—á–µ
    Array.from(elBuilt.querySelectorAll(".token")).forEach(el => {
      el.classList.remove("bad");
      el.classList.add("good");
    });
  } else {
    // –≤–∏–∑—É–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞: –∫–∞–∫–∏–µ —Ç–æ–∫–µ–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç –ø–æ –ø–æ–∑–∏—Ü–∏–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–ª–∏–Ω—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç
    const correctTokens = tokenizeFR(target);
    const builtEls = Array.from(elBuilt.querySelectorAll(".token"));
    if (correctTokens.length === state.built.length) {
      builtEls.forEach((el, idx) => {
        el.classList.remove("good","bad");
        if (correctTokens[idx] === state.built[idx]) el.classList.add("good");
        else el.classList.add("bad");
      });
    } else {
      builtEls.forEach(el => el.classList.remove("good","bad"));
    }

    elStatus.textContent = "‚ùå –ü–æ–∫–∞ –Ω–µ —Å–æ–≤–ø–∞–ª–æ. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Å—Ç–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ –∏–ª–∏ –Ω–∞–∂–º–∏ ‚Äú–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç‚Äù.";
    elStatus.className = "status no";
    if (state.results[state.i] !== "ok") state.results[state.i] = "fail";
  }
  updateSegments();
  saveProgress();
}

function showAnswer() {
  const s = SENTENCES[state.i];
  elAnswerFR.textContent = s.fr;
  elAnswerRU.textContent = s.ru;
  elAnswerBox.style.display = "block";
}

function go(delta){
  const next = state.i + delta;
  if (next < 0 || next >= SENTENCES.length) return;
  loadSentence(next);
}

// init
restoreProgress();
loadSentence(state.i || 0);
</script>
</body>
</html>
